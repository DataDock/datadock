image: ubuntu
environment:
  nodejs_version: "8.12.0"

install:
  - wget https://github.com/GitTools/GitVersion/releases/download/v4.0.0/GitVersion-bin-net40-v4.0.0.zip
  - unzip -d gitversion GitVersion-bin-net40-v4.0.0.zip
  - sh: nvm install $nodejs_version

before_build:
  - sh: |
      dotnet restore src/DataDock.sln
      mono gitversion/GitVersion.exe /l console /output buildserver /updateassemblyinfo
      GitVersion_SemVer=$(mono gitversion/GitVersion.exe /output json /showVariable SemVer)
      echo $GitVersion_SemVer

configuration: Release

build_script:
  - dotnet build -c Release src/DataDock.sln
  - msbuild /t:BuildImages /p:Tag=$GitVersion_SemVer build.proj 

test_script:
  - ps: |
      foreach ($test in ls src/*.Tests) {
        Push-Location $test
        echo "build: Testing project in $test"
        $testlog = $test.Name + ".log"
        dotnet test -c %CONFIGURATION% -l "trx;logfilename=$testlog" -r .
        Push-AppveyorArtifact $testlog
        if($LASTEXITCODE -ne 0) { $host.SetShouldExit($LastExitCode) }
        Pop-Location
      }
      

artifacts:
  - path: 'src/*.Tests/*.trx'

